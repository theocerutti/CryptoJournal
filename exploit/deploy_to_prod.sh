#!/bin/bash

build_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)
server="crypto-journal.light.ovh"
home="/home/ubuntu/crypto-journal"

# Deploy apache
scp -r 000-default.conf 000-default-le-ssl.conf ubuntu@${server}:/home/ubuntu/
ssh ubuntu@${server} "sudo mv /home/ubuntu/000-default.conf /etc/apache2/sites-available/000-default.conf"
ssh ubuntu@${server} "sudo mv /home/ubuntu/000-default-le-ssl.conf /etc/apache2/sites-available/000-default-le-ssl.conf"
ssh ubuntu@${server} "sudo systemctl reload apache2"

# Reload backend and run migrations
tar -zcvf backend.tar.gz ${build_dir}/../backend/docker ${build_dir}/../backend/docker-compose-prod.yml ${build_dir}/../backend/src ${build_dir}/../backend/nest-cli.json ${build_dir}/../backend/package*.json ${build_dir}/../backend/ts*.json
ssh ubuntu@${server} "mkdir -p ${home}/crypto-journal/"
scp -r $build_dir/backend.tar.gz ubuntu@${server}:/home/ubuntu/crypto-journal
ssh ubuntu@${server} "cd ${home} && tar -xzf backend.tar.gz && rm backend.tar.gz && cd backend && docker compose -f docker-compose-prod.yml up -d --build"

# Reload frontend
${build_dir}/../frontend/deploy_to_prod.sh
