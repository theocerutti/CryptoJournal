#!/bin/bash

build_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)
server="ubuntu@crypto-journal.light.ovh"
home="/home/ubuntu/crypto-journal/"

ssh ${server} "mkdir -p ${home}"

# Deploy apache
scp -r ${build_dir}/000-default.conf ${build_dir}/000-default-le-ssl.conf ${build_dir}/backup.sh ${server}:${home}
ssh ${server} "sudo mv ${home}/000-default.conf /etc/apache2/sites-available/000-default.conf"
ssh ${server} "sudo mv ${home}/000-default-le-ssl.conf /etc/apache2/sites-available/000-default-le-ssl.conf"
ssh ${server} "sudo mv ${home}/backup.sh /root/backup.sh && sudo chmod +x /root/backup.sh"
ssh ${server} "sudo systemctl reload apache2"

# Reload backend and run migrations
tar -zcvf backend.tar.gz \
  ${build_dir}/../backend/docker \
  ${build_dir}/../backend/docker-compose-prod.yml \
  ${build_dir}/../backend/src \
  ${build_dir}/../backend/nest-cli.json \
  ${build_dir}/../backend/package*.json \
  ${build_dir}/../backend/ts*.json
scp -r $build_dir/backend.tar.gz ${server}:${home}
rm backend.tar.gz

ssh ${server} "cd ${home} && rm -rf backend && tar -xzf backend.tar.gz && rm backend.tar.gz && cd backend && docker compose -f docker-compose-prod.yml up backend -d --build"

# Reload frontend
${build_dir}/../frontend/deploy_to_prod.sh
